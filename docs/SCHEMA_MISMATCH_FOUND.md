# Schema Mismatch Discovered

**Status:** BLOCKED - Need user decision

**Date:** 2026-01-07

---

## Problem

The gate test file expects a different database schema than what currently exists in Supabase.

## Actual Database Schema (Verified)

### `reference_library` (11 columns)
```
- id                 (uuid)
- project_id         (uuid, nullable)
- user_id            (uuid)
- file_id            (uuid, nullable)
- reference_url      (text) ⚠️ Test uses "file_url"
- tags               (array)
- approval_state     (text, default 'pending') ⚠️ Test uses boolean "is_approved"
- approved_by        (uuid, nullable)
- approved_at        (timestamp, nullable)
- metadata           (jsonb)
- created_at         (timestamp)
```

### `style_cards` (12 columns)
```
- id                 (uuid)
- project_id         (uuid)
- user_id            (uuid)
- name               (text)
- approved           (boolean) ⚠️ Test uses "is_approved"
- approved_at        (timestamp, nullable)
- approved_by        (uuid, nullable)
- reference_urls     (array)
- trigger_words      (array/jsonb)
- visual_rules       (jsonb)
- created_at         (timestamp)
- updated_at         (timestamp)
```

### `storyboard_frames` (Status: INCOMPLETE)
```
- Requires storyboard_id (NOT NULL)
- But: "storyboards" table DOES NOT EXIST ❌
- Cannot test without parent table
```

## Test Expectations (Mismatches)

The test file `test-workflow-gates-direct.mjs` tries to insert:

**reference_library:**
- ❌ `file_url` → Should be `reference_url`
- ❌ `file_type` → Column doesn't exist
- ❌ `reference_type` → Column doesn't exist
- ❌ `is_approved` (boolean) → Should be `approval_state` (text)

**style_cards:**
- ⚠️ `is_approved` → Should be `approved` (may work, need to verify)
- ✅ Other fields seem compatible

**storyboard_frames:**
- ❌ `shot_number` → Column doesn't exist
- ❌ `prompt` → Column doesn't exist
- ❌ `image_url` → Column doesn't exist
- ❌ `approval_state` → Unknown if exists
- ❌ Missing required `storyboard_id` → Parent table missing

## Migrations Status

### Found Migrations:
- `0016_reference_strictification_and_soft_delete.sql` - Adds `deleted_at` columns
- `0017_enforce_soft_delete_blocking.sql` - Adds blocking functions

### Issue:
These migrations assume tables have certain schemas (like `approved` field in style_cards), but they don't CREATE the base tables or missing columns.

## Resolution Options

### Option 1: Fix Test to Match Database
**Effort:** Medium
**Risk:** Low
**Pros:** Works with existing schema
**Cons:** Test may not validate intended workflow

Changes needed:
1. Use `reference_url` instead of `file_url`
2. Remove `file_type`, `reference_type`
3. Use `approval_state = 'approved'` instead of `is_approved = true`
4. Create `storyboards` table or skip storyboard tests
5. Adjust storyboard_frames fields

### Option 2: Fix Database to Match Test
**Effort:** High
**Risk:** Medium
**Pros:** Test validates intended workflow
**Cons:** Requires migration, might break existing code

Changes needed:
1. Create migration to add missing columns
2. Create `storyboards` table
3. Add indexes, constraints
4. Update existing code to use new schema

### Option 3: Hybrid Approach
**Effort:** Medium
**Risk:** Low
**Pros:** Best of both
**Cons:** More complex

1. Rename `reference_url` → `file_url` (alias/view)
2. Add computed column for `is_approved` based on `approval_state`
3. Create minimal `storyboards` table
4. Add missing columns where critical

## Recommendation

**BLOCKED - Need User Decision:**

1. **Which schema is correct?**
   - Is the test's expectation the "future state" (requires migration)?
   - Or is the current DB schema the "correct state" (requires test fix)?

2. **What about storyboards?**
   - Should I create the parent `storyboards` table?
   - Or should I remove storyboard tests for now?

3. **Migration strategy:**
   - Should I write a new migration (0018) to add missing columns?
   - Or should migrations 0016/0017 be updated to include column additions?

## Current State

- ✅ Database accessible
- ✅ 3 tables exist (projects, reference_library, style_cards, storyboard_frames)
- ❌ Schema mismatch prevents gate tests from running
- ❌ Migrations 0016/0017 not yet applied (would add deleted_at)
- ❌ Missing storyboards parent table

## Next Steps

**Waiting for user to choose:**
1. Fix test (Option 1)
2. Fix database (Option 2)
3. Hybrid (Option 3)
4. Other approach

---

*Generated by build controller during gate test verification*
